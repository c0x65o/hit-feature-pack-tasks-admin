# Feature Pack: job-core
# Core job management UI (execution history + scheduling)

name: job-core
title: System Jobs
description: "Core job management UI: execution history, schedules, and admin tools"

derived_services:
  - name: job
    description: Job execution worker
    run_mode: jobs
    command: node .hit/generated/hit_tasks_worker.cjs
    base_services_from: tasks
    requires_tasks: true
    options_key: worker
    env:
      HIT_TASKS_BASE_SERVICE: "{{base_service}}"
      HIT_APP_URL: "{{base_service_url}}"
    env_from_manifest:
      HIT_TASKS_CRON_TZ: reporting.timezone
    required_files:
      - .hit/generated/hit_tasks_worker.cjs
      - .hit/generated/hit_tasks_manifest.json

# Route definitions - mapped to React components
routes:
  - path: /admin/jobs
    page: EntityList
    params: { entityKey: job-core.task }
  - path: /admin/jobs/executions
    page: EntityList
    params: { entityKey: job-core.execution }
  - path: /admin/jobs/executions/[id]
    page: EntityDetail
    params: { entityKey: job-core.execution }
  - path: /admin/jobs/[name]
    page: EntityDetail
    params: { entityKey: job-core.task }
  - path: /admin/jobs/[name]/executions/[id]
    page: EntityDetail
    params: { entityKey: job-core.execution }

# Navigation contributions - auto-added to shell sidebar
nav:
  - id: jobs
    label: Jobs
    icon: CirclePlay
    group: system
    roles: [admin]
    showWhen: authenticated
    weight: 900
    children:
      - id: jobs-list
        label: List
        path: /admin/jobs
        icon: ListChecks
        weight: 100
        roles: [admin]
        showWhen: authenticated
      - id: jobs-executions
        label: Results
        path: /admin/jobs/executions
        icon: History
        weight: 110
        roles: [admin]
        showWhen: authenticated

# ─────────────────────────────────────────────────────────────────────────────
# PERMISSIONS - Action definitions (for admin-core permissions UI + runtime checks)
# ─────────────────────────────────────────────────────────────────────────────
# Permissions are schema-driven and live under:
#   schema/permissions.yaml

# Dependencies
# (no external module dependencies - TypeScript-only)

# ─────────────────────────────────────────────────────────────────────────────
# SCHEMA - Drizzle ORM table definitions (copied into app at build time)
# ─────────────────────────────────────────────────────────────────────────────
schema:
  source: src/schema/job-core.ts
  exports:
    - hitTaskSchedules
    - hitTaskExecutions
    - HitTaskSchedule
    - InsertHitTaskSchedule
    - HitTaskExecution
    - InsertHitTaskExecution

# ─────────────────────────────────────────────────────────────────────────────
# API ROUTES - Pack-owned endpoints (DB-first; works local + remote)
# ─────────────────────────────────────────────────────────────────────────────
api:
  routes:
    - path: /api/job-core/tasks
      methods: [GET]
      handler: "@hit/feature-pack-job-core/server/api/tasks"
      description: "List tasks from .hit/generated/hit_tasks_manifest.json with schedule + last run"
    - path: /api/job-core/tasks/[id]
      methods: [GET]
      handler: "@hit/feature-pack-job-core/server/api/tasks-id"
      description: "Get a single task definition by id (=task name)"
    - path: /api/job-core/tasks/[id]/run
      methods: [POST]
      handler: "@hit/feature-pack-job-core/server/api/tasks-id-run"
      description: "Enqueue a task execution row (DB-first); tasks worker will execute it"
    - path: /api/job-core/tasks/[id]/schedule
      methods: [PUT]
      handler: "@hit/feature-pack-job-core/server/api/tasks-id-schedule"
      description: "Enable/disable cron schedule for a task (DB-first)"
    - path: /api/job-core/executions
      methods: [GET]
      handler: "@hit/feature-pack-job-core/server/api/executions"
      description: "List task executions (DB-first)"
    - path: /api/job-core/executions/[id]
      methods: [GET]
      handler: "@hit/feature-pack-job-core/server/api/executions-id"
      description: "Get a task execution (DB-first)"
